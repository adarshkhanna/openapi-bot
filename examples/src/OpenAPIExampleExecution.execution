import library "OpenAPIExample/src/OpenAPIExampleLibrary.intent" as OpenAPILibrary
import library "CoreLibrary"
import platform "openapi-platform-model/src/OpenAPIPlatform.platform" as OpenAPIPlatform
import platform "ReactPlatform"

use provider ReactPlatform.ReactEventProvider


on intent Default_Fallback_Intent do
	ReactPlatform.Reply("This is awkward. I could not treat your request")
	ReactPlatform.Reply("Would you please try again")

////////// API /////////////////////
//We load here a definition from a url. We need to add more messages to guide the user about the questions he could ask
on intent LoadAPI do
	ReactPlatform.Reply("Loading API from " + context.get("API").get("_url") as String)
	val result = OpenAPIPlatform.LoadAPI(context.get("API").get("_url") as String)
	if(result.get("loaded") == false){
		val reason = result.get("reason") as String
		if(reason.equals("OpenAPIValidationException")){
			ReactPlatform.Reply("Oops, Your OpenAPI definition is not valid")
			ReactPlatform.Reply("Here is the validation report:")
			val reportItems = ReactPlatform.ItemizeList(result.get("report") as java.util.List<String>)
			ReactPlatform.Reply(reportItems as String)
		}
		else {
			ReactPlatform.Reply("Oops, I could not parse the API")
			ReactPlatform.Reply("Here is the error message:")
			ReactPlatform.Reply(result.get("errorMessage") as String)
		}
	}
	else {
		val api = result.get("api") as edu.uoc.som.openapi2.API
		ReactPlatform.Reply("The API "+api.getInfo().getTitle()+", version "+api.getInfo().getVersion()+", was successfully loaded")
		ReactPlatform.Reply("Ask me something")
	}
	
on intent GetAPIDetails do
	val api = session.get("xatkit.plugins.openapi.api") as edu.uoc.som.openapi2.API
	if(api === null){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	}
	else {
		ReactPlatform.Reply("The host serving the API is `"+api.getHost()+"`")
		ReactPlatform.Reply("The base path on which the API is served is `"+api.getBasePath()+"`")
		if(api.getSchemes().size()== 1){
			ReactPlatform.Reply("The transfer protocol of the API is `"+api.getSchemes().get(0)+"`")
		}
		if(api.getSchemes().size()>1){
			ReactPlatform.Reply("The transfer protocols of the API are:")
			ReactPlatform.ItemizeList(api.getSchemes())
		}
		ReactPlatform.Reply("The API includes "+api.getPaths().size()+ " paths and a total of "+api.getAllOperations().size()+ " operations")
		ReactPlatform.Reply("It also includes "+api.getDefinitions().size()+" definitions")
		ReactPlatform.Reply("What else do you want to know?")
	}

////////// Path intent /////////////////////
//Intents related to Path element
on intent ListPaths do
	val api = session.get("xatkit.plugins.openapi.api")
	if(api=== null){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else {
		val pathList = OpenAPIPlatform.ListPaths
		val pathEnum = ReactPlatform.EnumerateList(pathList as java.util.List<edu.uoc.som.openapi2.Path>)
		ReactPlatform.Reply(pathEnum as String)
	}
	


on intent GetPathDetails do
	val api = session.get("xatkit.plugins.openapi.api")
	if(api=== null){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else {
		val result = OpenAPIPlatform.GetPathDetails(context.get("RelativePath").get("relativePath")) as java.util.Map<String,Object>
		if(result.get("found") == true){
			val path = result.get("value") as edu.uoc.som.openapi2.Path
			val operations = result.get("operations") as java.util.List<edu.uoc.som.openapi2.Operation>
			if(operations.isEmpty()){
				ReactPlatform.Reply("There are no operations defined on this path")
			}
			else {
				ReactPlatform.Reply("There are "+operations.size()+" available operations on the path "+path.getRelativePath())
				val operationItemize = ReactPlatform.ItemizeList(operations)
				ReactPlatform.Reply(operationItemize as String)
			}
		}
		else {
			ReactPlatform.Reply("Oops! I could not find the path " + context.get("RelativePath").get("relativePath"))
			val pathItemize = ReactPlatform.ItemizeList(result.get("options") as java.util.List<edu.uoc.som.openapi2.Path>)
				ReactPlatform.Reply("The available paths on this API are: ")
				ReactPlatform.Reply(pathItemize as String)
			 }
		}
on intent GetNumberOfPath do
	val api = session.get("xatkit.plugins.openapi.api") as edu.uoc.som.openapi2.API
	if(api === null){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else {
		val result = OpenAPIPlatform.ListPaths as java.util.List<edu.uoc.som.openapi2.Path>
		ReactPlatform.Reply("There are " + result.size() + " paths in the API")
	}
	
////////// Operation intents /////////////////////
on intent ListOperationsOnPathUsingRowNumber  do
	val api = session.get("xatkit.plugins.openapi.api") as edu.uoc.som.openapi2.API
	if(api===null){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else {
		val operationList = OpenAPIPlatform.ListOperationsOnPathUsingRowNumber(context.get("Path").get("pathIdentifier") as String)
		val operationItemize = ReactPlatform.ItemizeList(operationList as java.util.List<edu.uoc.som.openapi2.Operation>)
		ReactPlatform.Reply("Here are the operations I found for the path:")
		ReactPlatform.Reply(operationItemize as String)
		}


on intent GetOperationById do
	val api = session.get("xatkit.plugins.openapi.api")
	if(api === null){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else {
		val result = OpenAPIPlatform.GetOperationById(context.get("Operation").get("operationId") as String) as java.util.Map<String, Object>
			if(result.get("found") == false){
				val operationItemize = ReactPlatform.ItemizeList(result.get("operations") as java.util.List<edu.uoc.som.openapi2.Operation>)
				ReactPlatform.Reply("Oops! I could not find the operation `"+context.get("Operation").get("operationId")+"`")
				ReactPlatform.Reply("The operations provided by the API are: ")
				ReactPlatform.Reply(operationItemize as String)
		}
		else {
			//Display the details of an operation
			val operation = result.get("value") as edu.uoc.som.openapi2.Operation
			ReactPlatform.Reply("`"+result.get("path")+"`: "+operation.getHTTPMethod()+" "+operation.getSummary()+" ("+operation.getOperationId()+"`)")
			val parameters = operation.getParameters() as java.util.List<edu.uoc.som.openapi2.Parameter>
			val responses = result.get("responses") as org.eclipse.emf.common.util.EMap<String, edu.uoc.som.openapi2.Response>
			if(parameters.isEmpty()){
				ReactPlatform.Reply("The operation does not declare any parameters")
			}
			else {
				if(parameters.size() == 1){
					ReactPlatform.Reply("The operation has "+parameters.size()+" parameter:")
				}
				else {
					ReactPlatform.Reply("The operation has "+parameters.size()+" parameters:")
				}
				val parameterItemize = ReactPlatform.ItemizeList(parameters)
				ReactPlatform.Reply(parameterItemize as String)
			}
			if(responses.isEmpty()){
				ReactPlatform.Reply("The operation does not declare any responses")
			}
			else {
				if(responses.size() == 1){
					ReactPlatform.Reply("The operation has "+responses.size()+" response:")
				}
				else {
					ReactPlatform.Reply("The operation has "+responses.size()+" responses:")
				}
			
				val responsesItemize = ReactPlatform.ItemizeList(responses)
				ReactPlatform.Reply(responsesItemize as String)
			}
		}
	}
	



	
on intent SupportedSchemes do
	val api = session.get("xatkit.plugins.openapi.api") as edu.uoc.som.openapi2.API
	if(api=== null){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else {
		val result = OpenAPIPlatform.SupportedSchemes as java.util.List<edu.uoc.som.openapi2.SchemeType>
		if(result.isEmpty()) {
			ReactPlatform.Reply("No transfer protocols found.")
			ReactPlatform.Reply("This means that the default scheme to be used is the one used to access the OpenAPI definition itself.")
		} else {
			ReactPlatform.Reply("This API supports: ")
			val itemize = ReactPlatform.ItemizeList(result)
			ReactPlatform.Reply(itemize as String)
		}
	}



on intent AskLicenseInfo do 
	val api = session.get("xatkit.plugins.openapi.api")
	if(api=== null){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else {
		val result = OpenAPIPlatform.GetLicense
		ReactPlatform.Reply("The license is " + result)
		}

	



on intent GetOperationByPathAndHttpMethod do
	val api = session.get("xatkit.plugins.openapi.api") as edu.uoc.som.openapi2.API
	if(api === null){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else { 
		val result = OpenAPIPlatform.GetOperationByPathAndHttpMethod(context.get("Operation").get("operationPath") as String, context.get("Operation").get("operationHttpMethod") as String) as java.util.Map<String,Object>
		if(result.get("found") == false){
			val reason = result.get("reason") as String
			//operation not found 
			if(reason.equals("OperationNotFound")){
				val operationItemize = ReactPlatform.ItemizeList(result.get("options") as java.util.List<edu.uoc.som.openapi2.Operation>)
				ReactPlatform.Reply("Oops! I could not find the operation "+context.get("Operation").get("operationHttpMethod")+" on the path "+context.get("Operation").get("operationPath"))
				ReactPlatform.Reply("The available operations on this path are: ")
				ReactPlatform.Reply(operationItemize as String)
			}
			if(reason.equals("PathNotFound")){
				val pathItemize = ReactPlatform.ItemizeList(result.get("options") as java.util.List<edu.uoc.som.openapi2.Path>)
				ReactPlatform.Reply("Oops! I could not find the path "+context.get("Operation").get("operationPath"))
				ReactPlatform.Reply("The available paths on this API are: ")
				ReactPlatform.Reply(pathItemize as String)
			}
		}
		else {
			//Display the details of an operation
			val operation = result.get("value") as edu.uoc.som.openapi2.Operation
			ReactPlatform.Reply("`"+context.get("Operation").get("operationHttpMethod")+": "+context.get("Operation").get("operationPath")+operation.getSummary()+" (`"+operation.getOperationId()+"`)")
			val parameters = operation.getParameters() as java.util.List<edu.uoc.som.openapi2.Parameter>
			val responses = result.get("responses") as org.eclipse.emf.common.util.EMap<String, edu.uoc.som.openapi2.Response>
			if(parameters.isEmpty()){
				ReactPlatform.Reply("The operation does not declare any parameters")
				
			}
			else {
				if(parameters.size() == 1){
					ReactPlatform.Reply("The operation has "+parameters.size()+" parameter:")
				}
				else {
					ReactPlatform.Reply("The operation has "+parameters.size()+" parameters:")
				}
			
				val parameterItemize = ReactPlatform.ItemizeList(parameters)
				ReactPlatform.Reply(parameterItemize as String)
			
			}
			if(responses.isEmpty()){
				ReactPlatform.Reply("The operation does not declare any responses")	
			}
			else {
				if(parameters.size() == 1){
					ReactPlatform.Reply("The operation has "+responses.size()+" response:")
				}
				else {
					ReactPlatform.Reply("The operation has "+responses.size()+" responses:")
				}
			
				val responsesItemize = ReactPlatform.ItemizeList(responses)
				ReactPlatform.Reply(responsesItemize as String)
			}
		}	
	}
	




//Security actions	
on intent IsAuthenticationRequired do
	val api = session.get("xatkit.plugins.openapi.api")
	if(api === null){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else {  
		val result = OpenAPIPlatform.IsAuthenticationRequired as org.eclipse.emf.common.util.EMap<String, Object>
		val security = result.get("security") as java.util.List<edu.uoc.som.openapi2.SecurityRequirement>
		if(security.isEmpty) {
			ReactPlatform.Reply("No")
		}
		else {
			ReactPlatform.Reply("Yes")
		}
	}
	
on intent IsAuthenticationRequiredOperation do
	val api = session.get("xatkit.plugins.openapi.api")
	if(api.isNull()){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else {  
		def result = OpenAPIPlatform.IsAuthenticationRequiredOperation(operationId : context(Operation).get("operationId"))
		if(result.get("found") == false){
			def operationItemize = ReactPlatform.ItemizeList(list : result.get("operations"))
			ReactPlatform.Reply("Oops! I could not find the operation "+context(Operation).get("operationId"))
			ReactPlatform.Reply("The operations provided by the API are: ")
			ReactPlatform.Reply(operationItemize)
		}
	else {
		def answer = result.get("answer")
		if(answer == false){
			ReactPlatform.Reply("No authentication required to execute this operation.")
			}
			else {
				def options = ReactPlatform.ItemizeList(list : result.get("options"))
				ReactPlatform.Reply("Yes, authentication is needed to execute the operation "+ context(Operation).get("operationId"))
			
			}
		}
	}
	
on intent SecuritySchemeList do
	def api = session.get("xatkit.plugins.openapi.api")
	if(api.isNull()){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else {  
		def result = OpenAPIPlatform.SecuritySchemeList
		if(result.isEmpty()){
			ReactPlatform.Reply("No security schemes found")
		}
		else {
			def securitySchemeItemize = ReactPlatform.ItemizeList(list : result)
			ReactPlatform.Reply("The security schemes provided by the API are: ")
			ReactPlatform.Reply(securitySchemeItemize)
		}
	}
	
on intent SecuritySchemeDetails do
	def api = session.get("xatkit.plugins.openapi.api")
	if(api.isNull()){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else { 
		def result = OpenAPIPlatform.SecuritySchemeDetails(securitySchemeId : context(SecurityScheme).get("securitySchemeId"))
		if(result.get("found") == false){
			ReactPlatform.Reply("Oops! I could not find the security scheme "+context(SecurityScheme).get("securitySchemeId"))
		} else {
			def securityScheme = result.get("value")
			 ReactPlatform.Reply("Here is the definition of the security scheme "+context(SecurityScheme).get("securitySchemeId")+":  \nType: "+securityScheme.getType()+"  \nName: "+securityScheme.getName()+"  \nIn: "+securityScheme.getLocation())
			}
		}

////////// Schema intents /////////////////////
 on intent ListSchemaDefinitions do 
 	def api = session.get("xatkit.plugins.openapi.api")
	if(api.isNull()){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else { 
 		def result = OpenAPIPlatform.ListSchemaDefinitions
 		if(result.isEmpty()){
 			ReactPlatform.Reply("No schema definitions found")
 		}
 		else {
 			def schemaItems = ReactPlatform.EnumerateList(list : result)
 			 ReactPlatform.Reply(schemaItems)
 		}
 	}
 	

on intent GetSchemaDetails do
	def api = session.get("xatkit.plugins.openapi.api")
	if(api.isNull()){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else { 
 		def result = OpenAPIPlatform.GetSchemaDetails(schemaName : context(Schema).get("schemaName"))
 		if(result.get("found") == false){
 			ReactPlatform.Reply("Oops! I could not find the schema "+ context(Schema).get("schemaName"))
 			def schemaItemize = ReactPlatform.ItemizeList(list : result.get("options"))
			ReactPlatform.Reply("The available schema definitions are: ")
			ReactPlatform.Reply(schemaItemize)
 		}
 		else {
 			def schema = result.get("value")
 			def propertiesItems = ReactPlatform.ItemizeList(list : schema.getProperties())
 			ReactPlatform.Reply(propertiesItems)
 		}
 	}
 	
on intent GetOperationsConsumingSchema do 
	def api = session.get("xatkit.plugins.openapi.api")
	if(api.isNull()){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else { 
		def result = OpenAPIPlatform.GetOperationsConsumingSchema(schemaName : context(Schema).get("schemaName"))
		if(result.get("found")== false){
			def reason = result.get("reason")
			//the schema could not found on the definition
			if(reason.equals("SchemaNotFound")){
				ReactPlatform.Reply("Oops! I could not find the schema "+ context(Schema).get("schemaName"))
 				def schemaItemize = ReactPlatform.ItemizeList(list : result.get("options"))
				ReactPlatform.Reply("The available schema definitions are: ")
				ReactPlatform.Reply(schemaItemize)
			}
			if(reason.equals("Empty")){
				ReactPlatform.Reply("No operations found")
			}
		}
		else {
			def operationItemize = ReactPlatform.ItemizeList(list : result.get("value"))
			ReactPlatform.Reply("The operations which consume instances of "+context(Schema).get("schemaName")+" are:")
			ReactPlatform.Reply(operationItemize)
		}
	}
	
	
on intent GetOperationsReturningSchema do
	def api = session.get("xatkit.plugins.openapi.api")
	if(api.isNull()){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else { 
		def result = OpenAPIPlatform.GetOperationsReturningSchema(schemaName : context(Schema).get("schemaName"))
		if(result.get("found")== false){
			def reason = result.get("reason")
			//the schema could not found on the definition
			if(reason.equals("SchemaNotFound")){
				ReactPlatform.Reply("Oops! I could not find the schema "+ context(Schema).get("schemaName"))
 				def schemaItemize = ReactPlatform.ItemizeList(list : result.get("options"))
				ReactPlatform.Reply("The available schema definitions are: ")
				ReactPlatform.Reply(schemaItemize)
			}
			if(reason.equals("Empty")){
				ReactPlatform.Reply("No operations found")
			}
		}
		else {
			def operationItemize = ReactPlatform.ItemizeList(list : result.get("value"))
			ReactPlatform.Reply("The operations which return instances of "+context(Schema).get("schemaName")+" are:")
			ReactPlatform.Reply(operationItemize)
		}	
	}
 
 on intent GetOperationsReusingSchemaParts do
	def api = session.get("xatkit.plugins.openapi.api")
	if(api.isNull()){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else { 
		def result = OpenAPIPlatform.GetOperationsReusingSchemaParts(schemaName : context(Schema).get("schemaName"))
		if(result.get("found")== false){
			def reason = result.get("reason")
			//the schema could not found on the definition
			if(reason.equals("SchemaNotFound")){
				ReactPlatform.Reply("Oops! I could not find the schema "+ context(Schema).get("schemaName"))
 				def schemaItemize = ReactPlatform.ItemizeList(list : result.get("options"))
				ReactPlatform.Reply("The available schema definitions are: ")
				ReactPlatform.Reply(schemaItemize)
			}
			if(reason.equals("Empty")){
				ReactPlatform.Reply("I could not find anything")
			}
		}
		else {
			def operationItemize = ReactPlatform.ItemizeList(list : result.get("value"))
			ReactPlatform.Reply("I think these properties of the definition "+context(Schema).get("schemaName")+" are used by some operations:")
			ReactPlatform.Reply(operationItemize)
		}	
	}

 	
 on intent GetSchemasReusingSchemaParts do
	def api = session.get("xatkit.plugins.openapi.api")
	if(api.isNull()){
		ReactPlatform.Reply("You need to load an API first")
		ReactPlatform.Reply("What is the URL of the API you want to know about?")
	} else { 
		def result = OpenAPIPlatform.GetSchemasReusingSchemaParts(schemaName : context(Schema).get("schemaName"))
		if(result.get("found")== false){
			def reason = result.get("reason")
			//the schema could not found on the definition
			if(reason.equals("SchemaNotFound")){
				ReactPlatform.Reply("Oops! I could not find the schema "+ context(Schema).get("schemaName"))
 				def schemaItemize = ReactPlatform.ItemizeList(list : result.get("options"))
				ReactPlatform.Reply("The available schema definitions are: ")
				ReactPlatform.Reply(schemaItemize)
			}
			if(reason.equals("Empty")){
				ReactPlatform.Reply("Sorry, I couldn't find anything")
			}
		}
		else {
			def schemaItemize = ReactPlatform.ItemizeList(list : result.get("value"))
			ReactPlatform.Reply("I think these properties of the definition "+context(Schema).get("schemaName")+" are used in other definitions:")
			ReactPlatform.Reply(schemaItemize)
		}	
	}

 	
	
	